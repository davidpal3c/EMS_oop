@page "/reports"
@using Interfaces
@using Models
@using Services
@inject DBService DBService
@inject EmployeeService EmployeeService
@inject PayrollService PayrollService


<h3>Reports</h3>

<div>Manage Reports</div>
<div class="page-header-ems">
    <div class="page-header-ems-section">
        <select @bind="selectedReport">
            @foreach (Report.EReportType rt in Enum.GetValues(typeof(Report.EReportType)))
            {
                <option value="@rt">@rt.ToString()</option>
            }
        </select>
    </div>

</div>
<div class="page-ems">
    <div class="page-section-ems">
        @if (reportList.Count > 0)
        {
            <table class="table table-hover" id="myTable">
                @if (selectedReport == Report.EReportType.EmployeeDirectory)
                {
                    <thead>
                        <tr class="thead-border">
                            <th>Id</th>
                            <th>Employee Name</th>
                            <th>Email</th>
                            <th>Position</th>
                            <th>Salary</th>
                            <th>CreatedAt</th>
                            <th>UpdatedAt</th>
                            <th class="td-actions"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (EmployeeDirectoryReport rep in reportList)
                        {
                            <tr>
                                <td>@rep.Id</td>
                                <td>@rep.Name</td>
                                <td>@rep.Email</td>
                                <td>@rep.Position</td>
                                <td>@rep.Salary</td>
                                <td>@rep.CreatedAt</td>
                                <td>@rep.UpdatedAt</td>
                                <td class="td-actions">
                                    <button type="submit" class="btn btn-primary" data-toggle="tooltip" data-placement="top" data-trigger="top" title="Export">
                                        <i class="bi bi-arrow-right"></i>Export
                                    </button>
                                    <button type="submit" class="btn btn-primary" data-toggle="tooltip" data-placement="top" data-trigger="top" title="Print">
                                        <i class="bi bi-arrow-right"></i>Print
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                }
            
                else if (selectedReport == Report.EReportType.Attendance)
                {
                    <thead>
                        <tr class="thead-border">
                            <th>Date</th>
                            <th>Employee Id</th>
                            <th>Employee Name</th>
                            <td>Hours Worked</td>
                            <td>Email</td>
                            <th>Position</th>
                            <th>CreatedAt</th>
                            <th class="td-actions"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (AttendanceReport rep in reportList)
                        {
                            <tr>
                                <td>@rep.Date</td>
                                <td>@rep.Id</td>
                                <td>@rep.Name</td>
                                <td>@rep.HoursWorked</td>
                                <td>@rep.Email</td>
                                <td>@rep.Position</td>
                                <td>@rep.CreatedAt</td>
                                <td class="td-actions">
                                    <button type="submit" class="btn btn-primary" data-toggle="tooltip" data-placement="top" data-trigger="top" title="Export">
                                        <i class="bi bi-arrow-right"></i>Export
                                    </button>
                                    <button type="submit" class="btn btn-primary" data-toggle="tooltip" data-placement="top" data-trigger="top" title="Print">
                                        <i class="bi bi-arrow-right"></i>Print
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                }            
                else if (selectedReport == Report.EReportType.LeaveAndAbsence)
                {
                    <thead>
                        <tr class="thead-border">
                            <th>Date</th>
                            <th>Employee Id</th>
                            <th>Employee Name</th>
                            <td>Hours Worked</td>
                            <th>Position</th>                            
                            <th>CreatedAt</th>
                            <th class="td-actions"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (LeaveAndAbsenceReport rep in reportList)
                        {
                            <tr>
                                <td>@rep.Date</td>
                                <td>@rep.Id</td>
                                <td>@rep.Name</td>
                                <td>@rep.HoursWorked</td>
                                <td>@rep.Email</td>
                                <td>@rep.Position</td>
                                <td>@rep.CreatedAt</td>
                                <td class="td-actions">
                                    <button type="submit" class="btn btn-primary" data-toggle="tooltip" data-placement="top" data-trigger="top" title="Export">
                                        <i class="bi bi-arrow-right"></i>Export
                                    </button>
                                    <button type="submit" class="btn btn-primary" data-toggle="tooltip" data-placement="top" data-trigger="top" title="Print">
                                        <i class="bi bi-arrow-right"></i>Print
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>                
                }
            </table>
        }
        else
        {
            <div>No records available for the selected report type.</div>
        }
    </div>
</div>


@code {


    private Report.EReportType selectedReport = Report.EReportType.EmployeeDirectory;
    private List<Report> reportList = new List<Report>();
    private string? msg;
    private string alert = "alert-success";

    protected override async Task OnInitializedAsync()
    {
        if (DBService.IsSuccessfulConnection())
        {
            //msg = "DB Connection - OK!";
        }
        else
        {
            msg = "Reconfigure connection string at MauiProgram.cs";
            alert = "alert-danger";
        }

        await RefreshList();
    }

    private async Task RefreshList()
    {  
        try
        {
            Report rep = new Report();
            var fetchedReports = await rep.GenerateReport(selectedReport);

            reportList.Clear();

            foreach (var r in fetchedReports)
            {
                switch (selectedReport)
                {
                    case Report.EReportType.EmployeeDirectory:
                        reportList.Add((EmployeeDirectoryReport)r);
                        break;

                    case Report.EReportType.Attendance:
                        reportList.Add((AttendanceReport)r);
                        break;

                    case Report.EReportType.LeaveAndAbsence:
                        reportList.Add((LeaveAndAbsenceReport)r);
                        break;

                    default:
                        throw new ArgumentException("Invalid report type");
                }
            }        
        }
        catch (Exception e)
        {
            msg = $"Error during refresh: {e.Message}";
            alert = "alert-danger";
        }
    }
    
}
